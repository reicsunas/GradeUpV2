<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GradeUp LMS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
    body { font-family: 'Roboto', sans-serif; }
  </style>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-pink-50">
  <div id="app-root"></div>
  <div id="modal-container"></div>
  <div id="toast-container" class="fixed top-5 right-5 z-50"></div>

  <script type="module">
    // ==========================================
    // 1. KONFIGURASI SUPABASE (ISI BAGIAN INI!)
    // ==========================================
    // PENTING: Ganti string di bawah ini dengan Project URL dan Anon Key Anda dari Dashboard Supabase
    const SUPABASE_URL = 'https://pyzgqpsbofnkcltqpwta.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5emdxcHNib2Zua2NsdHFwd3RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MTA5NDYsImV4cCI6MjA3ODQ4Njk0Nn0.HhaP77adou_CpwrmOF1fZdx93Io2tSPHPcLfjEKxyi4';

    // --- PENGAMANAN KONFIGURASI ---
    if (SUPABASE_URL.includes('GANTI_DENGAN') || !SUPABASE_URL.startsWith('http')) {
      document.getElementById('app-root').innerHTML = `
        <div class="min-h-screen flex items-center justify-center p-4">
          <div class="bg-white p-8 rounded-xl shadow-xl max-w-lg text-center border-t-4 border-red-500">
            <h1 class="text-2xl font-bold text-red-600 mb-4">‚ö†Ô∏è Konfigurasi Diperlukan</h1>
            <p class="text-gray-700 mb-4">Aplikasi belum terhubung ke Supabase. Anda perlu memasukkan <strong>URL Proyek</strong> dan <strong>Anon Key</strong> Anda.</p>
            <div class="bg-gray-100 p-4 rounded text-left text-sm font-mono mb-4 overflow-x-auto">
                // Cari bagian ini di kode (baris ~25):<br>
                const SUPABASE_URL = '...';<br>
                const SUPABASE_ANON_KEY = '...';
            </div>
            <p class="text-sm text-gray-500">Silakan edit file <code>index.html</code> dan masukkan kredensial dari dashboard Supabase Anda.</p>
            <button onclick="location.reload()" class="mt-6 bg-pink-500 text-white px-6 py-2 rounded hover:bg-pink-600 transition">Muat Ulang Halaman</button>
          </div>
        </div>
      `;
      throw new Error("Supabase URL belum dikonfigurasi. Silakan edit kode."); 
    }

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ==========================================
    // 2. STATE GLOBAL
    // ==========================================
    let currentUser = null;
    let users = [];
    let assignments = [];
    let submissions = [];
    let subjects = [];
    
    let currentView = 'login';
    let selectedAssignmentId = null;
    let editingUser = null;
    let userToDelete = null;

    // Cache file upload
    let taskFileName = null;
    let submissionFileName = null;

    // ==========================================
    // 3. FUNGSI LOGIKA (Backend)
    // ==========================================

    // --- LOGIN ---
    const login = (username, password) => {
      const user = users.find(u => u.username === username && u.password === password);
      if (user) {
        currentUser = user;
        return { success: true, user };
      }
      return { success: false, message: 'Username atau password salah.' };
    };

    const logout = () => {
      currentUser = null;
      setView('login');
    };

    // --- BUAT TUGAS (GURU) ---
    const addAssignment = async (title, subject, deadline, description) => {
      if (!currentUser) return;
      const deadlineISO = new Date(deadline).toISOString();

      const { data, error } = await supabaseClient
        .from('assignments')
        .insert({
          id: `t${Date.now()}`,
          title: title,
          subject: subject,
          deadline: deadlineISO,
          description: description,
          file_url: taskFileName ? `https://fake-link.com/${taskFileName}` : null,
          created_by: currentUser.id
        })
        .select()
        .single();

      if (error) {
        console.error("Gagal upload tugas:", error);
        return { success: false, message: error.message };
      }

      assignments.unshift(data);
      return { success: true, assignment: data };
    };

    // --- KUMPUL TUGAS (SISWA) ---
    const submitAssignment = async (assignmentId, fileName) => {
      if (!currentUser) return;

      const existingSub = submissions.find(s => s.assignment_id === assignmentId && s.student_id === currentUser.id);
      const subId = existingSub ? existingSub.id : `sub${Date.now()}`;

      const submissionData = {
        id: subId,
        assignment_id: assignmentId,
        student_id: currentUser.id,
        submitted_at: new Date().toISOString(),
        file_url: `https://fake-link.com/${fileName}`,
        file_name: fileName,
        grade: null,
        feedback: null
      };

      // Upsert ke Supabase
      const { data, error } = await supabaseClient
        .from('submissions')
        .upsert(submissionData)
        .select()
        .single();

      if (error) {
        console.error("Gagal kumpul tugas:", error);
        return { success: false, message: error.message };
      }

      if (existingSub) {
        const idx = submissions.indexOf(existingSub);
        submissions[idx] = data;
      } else {
        submissions.unshift(data);
      }
      return { success: true, submission: data };
    };

    // --- INPUT NILAI (GURU) ---
    const gradeSubmission = async (submissionId, grade, feedback) => {
      const { data, error } = await supabaseClient
        .from('submissions')
        .update({ grade: Number(grade), feedback: feedback })
        .eq('id', submissionId)
        .select()
        .single();

      if (error) {
        return { success: false, message: error.message };
      }

      const idx = submissions.findIndex(s => s.id === submissionId);
      if (idx !== -1) submissions[idx] = data;
      
      return { success: true };
    };

    // --- ADMIN USER MANAGEMENT ---
    const adminDeleteUser = async (userId) => {
      if (userId === 'u1') return { success: false, message: 'Admin utama tidak bisa dihapus.' };
      
      const { error } = await supabaseClient.from('users').delete().eq('id', userId);
      if (error) return { success: false, message: error.message };
      
      users = users.filter(u => u.id !== userId);
      return { success: true, message: 'User dihapus.' };
    };
    
    // Helpers Data
    const getStudentSubmissions = (studentId) => submissions.filter(s => s.student_id === studentId);
    const getAssignmentSubmissions = (assignmentId) => submissions.filter(s => s.assignment_id === assignmentId);
    const findUserById = (userId) => users.find(u => u.id === userId);
    
    function formatDeadline(dateString) {
      if (!dateString) return "-";
      const date = new Date(dateString);
      return date.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    function isOverdue(dateString) {
      return new Date(dateString) < new Date();
    }

    // ==========================================
    // 4. KOMPONEN UI (String Templates)
    // ==========================================
    // (Komponen UI sama seperti sebelumnya, tidak ada perubahan signifikan di bagian ini)
    const Button = ({ children, onClick, type = 'button', variant = 'primary', className = '' }) => {
      const colors = {
        primary: 'bg-pink-500 text-white hover:bg-pink-600',
        secondary: 'bg-pink-100 text-pink-700 hover:bg-pink-200',
        danger: 'bg-red-500 text-white hover:bg-red-600'
      };
      return `<button type="${type}" onclick="${onClick}" class="w-full py-3 px-4 rounded-lg font-semibold shadow-md transition duration-300 ${colors[variant]} ${className}">${children}</button>`;
    };

    const Input = ({ label, id, type = 'text', value = '', required = false }) => `
      <div class="mb-4">
        <label class="block text-sm font-medium text-pink-800 mb-1">${label}</label>
        <input type="${type}" id="${id}" value="${value}" ${required ? 'required' : ''} class="w-full px-4 py-2 border border-pink-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400" />
      </div>`;

    const Select = ({ label, id, options }) => `
      <div class="mb-4">
        <label class="block text-sm font-medium text-pink-800 mb-1">${label}</label>
        <select id="${id}" class="w-full px-4 py-2 border border-pink-200 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-pink-400">
          ${options.map(o => `<option value="${o.value}">${o.label}</option>`).join('')}
        </select>
      </div>`;

    const Card = (content) => `<div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">${content}</div>`;
    const Header = (title) => `<div class="p-4 bg-pink-50 border-b border-pink-100"><h3 class="text-xl font-semibold text-pink-800">${title}</h3></div>`;
    const Content = (body) => `<div class="p-6">${body}</div>`;

    // ==========================================
    // 5. RENDER PAGES
    // ==========================================

    function renderLoginPage() {
      return `
      <div class="flex items-center justify-center min-h-screen bg-pink-50 p-4">
        <div class="w-full max-w-md bg-white rounded-xl shadow-lg border-t-4 border-pink-400 p-8">
          <h2 class="text-3xl font-bold text-center text-pink-800 mb-6">GradeUp</h2>
          <div id="login-error" class="hidden bg-red-100 text-red-700 p-3 rounded mb-4"></div>
          <form onsubmit="window.handleLogin(event)">
            ${Input({ label: "Username", id: "login-username", required: true })}
            ${Input({ label: "Password", id: "login-password", type: "password", required: true })}
            <div class="mt-6">${Button({ type: "submit", children: "Login" })}</div>
          </form>
        </div>
      </div>`;
    }

    function renderStudentDashboard() {
      const mySubmissions = getStudentSubmissions(currentUser.id);
      const doneIds = mySubmissions.map(s => s.assignment_id);
      const todo = assignments.filter(a => !doneIds.includes(a.id));
      const done = mySubmissions.map(sub => {
        const task = assignments.find(a => a.id === sub.assignment_id);
        return { ...sub, task };
      }).filter(item => item.task);

      const todoList = todo.length ? todo.map(t => `
        <li class="py-4 flex justify-between items-center border-b border-pink-100">
          <div>
            <button onclick="window.viewTask('${t.id}')" class="text-lg font-bold text-pink-700 hover:underline">${t.title}</button>
            <p class="text-sm text-gray-600">${t.subject}</p>
          </div>
          <span class="text-sm ${isOverdue(t.deadline) ? 'text-red-500 font-bold' : 'text-gray-600'}">Deadline: ${formatDeadline(t.deadline)}</span>
        </li>`).join('') : '<p class="text-gray-500 text-center">Tidak ada tugas baru.</p>';

      const doneList = done.length ? done.map(d => `
        <li class="py-4 flex justify-between items-center border-b border-pink-100">
          <div>
            <button onclick="window.viewTask('${d.task.id}')" class="text-lg font-bold text-pink-700 hover:underline">${d.task.title}</button>
            <p class="text-sm text-gray-600">Dikumpulkan: ${formatDeadline(d.submitted_at)}</p>
          </div>
          <span class="text-xl font-bold ${d.grade ? 'text-pink-600' : 'text-gray-400'}">${d.grade ?? 'Dinilai'}</span>
        </li>`).join('') : '<p class="text-gray-500 text-center">Belum ada riwayat.</p>';

      return `
      <div class="container mx-auto p-6">
        <h1 class="text-3xl font-bold text-pink-800 mb-6">Halo, ${currentUser.full_name} üëã</h1>
        ${Card(Header("Tugas Baru") + Content(`<ul>${todoList}</ul>`))}
        ${Card(Header("Riwayat") + Content(`<ul>${doneList}</ul>`))}
      </div>`;
    }

    function renderTeacherDashboard() {
      const myTasks = assignments.filter(a => a.created_by === currentUser.id);
      const taskRows = myTasks.map(t => {
        const subCount = submissions.filter(s => s.assignment_id === t.id).length;
        return `
        <tr class="border-b border-pink-100 hover:bg-pink-50">
          <td class="p-3"><button onclick="window.viewTask('${t.id}')" class="font-bold text-pink-700 hover:underline">${t.title}</button></td>
          <td class="p-3">${t.subject}</td>
          <td class="p-3">${subCount} Siswa</td>
        </tr>`;
      }).join('');

      return `
      <div class="container mx-auto p-6">
        <div class="flex justify-between items-center mb-6">
          <h1 class="text-3xl font-bold text-pink-800">Dashboard Guru</h1>
          <div class="w-48">${Button({ onClick: "window.setView('createTask')", children: "+ Buat Tugas" })}</div>
        </div>
        ${Card(Header("Tugas Saya") + Content(myTasks.length ? `<table class="w-full text-left"><thead><tr class="text-pink-800"><th>Judul</th><th>Mapel</th><th>Pengumpulan</th></tr></thead><tbody>${taskRows}</tbody></table>` : '<p class="text-center text-gray-500">Belum ada tugas.</p>'))}
      </div>`;
    }

    function renderAdminDashboard() {
      const userRows = users.map(u => `
        <tr class="border-b border-pink-100">
          <td class="p-3">${u.full_name}</td>
          <td class="p-3">${u.username}</td>
          <td class="p-3 capitalize">${u.role}</td>
          <td class="p-3"><button onclick="window.handleDeleteUser('${u.id}')" class="text-red-500 hover:underline">Hapus</button></td>
        </tr>`).join('');

      return `
      <div class="container mx-auto p-6">
        <h1 class="text-3xl font-bold text-pink-800 mb-6">Admin Panel</h1>
        ${Card(Header("Manajemen User") + Content(`<table class="w-full text-left"><thead><tr><th>Nama</th><th>Username</th><th>Role</th><th>Aksi</th></tr></thead><tbody>${userRows}</tbody></table>`))}
      </div>`;
    }

    function renderCreateTask() {
      if (subjects.length === 0) {
        return `<div class="container mx-auto p-6 text-center"><h2 class="text-red-600 font-bold">Data Mata Pelajaran Kosong</h2><button onclick="window.setView('dashboard')" class="mt-4 text-pink-600 underline">Kembali</button></div>`;
      }
      const subjectOpts = subjects.map(s => ({ value: s, label: s }));
      return `
      <div class="container mx-auto p-6 max-w-2xl">
        <button onclick="window.setView('dashboard')" class="mb-4 text-pink-600">‚Üê Kembali</button>
        ${Card(Header("Buat Tugas Baru") + Content(`
          <form onsubmit="window.handleCreateTask(event)">
            ${Input({ label: "Judul Tugas", id: "task-title", required: true })}
            ${Select({ label: "Mata Pelajaran", id: "task-subject", options: subjectOpts })}
            ${Input({ label: "Deadline", id: "task-deadline", type: "datetime-local", required: true })}
            <div class="mb-4"><label class="block text-sm font-medium text-pink-800">Deskripsi</label><textarea id="task-desc" rows="4" class="w-full p-2 border border-pink-200 rounded-lg" required></textarea></div>
            <div class="mb-4"><label class="block text-sm font-medium text-pink-800">File</label><input type="file" onchange="window.taskFileName = this.files[0]?.name" class="block w-full text-sm text-gray-500 mt-1"/></div>
            ${Button({ type: "submit", children: "Terbitkan" })}
          </form>
        `))}
      </div>`;
    }

    function renderTaskDetail() {
      const task = assignments.find(a => a.id === selectedAssignmentId);
      if (!task) return `<div class="p-6">Tugas tidak ditemukan. <button onclick="window.setView('dashboard')">Kembali</button></div>`;

      if (currentUser.role === 'student') {
        const sub = submissions.find(s => s.assignment_id === task.id && s.student_id === currentUser.id);
        let statusHtml = sub 
            ? `<div class="bg-green-50 p-4 rounded-lg border border-green-200"><p class="font-bold text-green-800">‚úÖ Sudah Dikumpulkan</p><p class="text-sm">File: ${sub.file_name}</p>${sub.grade ? `<div class="mt-2 font-bold text-2xl text-pink-600">Nilai: ${sub.grade}</div><p class="italic text-gray-600">"${sub.feedback}"</p>` : '<p class="text-sm italic text-gray-500 mt-1">Menunggu dinilai</p>'}</div>`
            : `<form onsubmit="window.handleSubmitTask(event)"><label class="block mb-2 font-bold text-pink-800">Upload Jawaban</label><input type="file" required onchange="window.submissionFileName = this.files[0]?.name" class="mb-4 block w-full text-sm"/>${Button({ type: "submit", children: "Kumpulkan Tugas" })}</form>`;

        return `
        <div class="container mx-auto p-6 max-w-2xl">
            <button onclick="window.setView('dashboard')" class="mb-4 text-pink-600">‚Üê Kembali</button>
            ${Card(Header(task.title) + Content(`<span class="bg-pink-100 text-pink-800 px-2 py-1 rounded text-xs">${task.subject}</span><p class="my-4 text-gray-700">${task.description}</p><p class="mb-6 text-sm text-gray-500">Deadline: ${formatDeadline(task.deadline)}</p><hr class="my-4 border-pink-100"/>${statusHtml}`))}
        </div>`;
      }

      if (currentUser.role === 'teacher') {
        const subs = submissions.filter(s => s.assignment_id === task.id);
        const subList = subs.map(s => {
            const student = users.find(u => u.id === s.student_id);
            return `
            <div class="border-b border-pink-100 p-4 flex justify-between items-start">
                <div><p class="font-bold text-pink-800">${student ? student.full_name : 'Unknown'}</p><p class="text-xs text-gray-500">File: ${s.file_name}</p></div>
                <form onsubmit="window.handleGrade(event, '${s.id}')" class="flex gap-2 items-end">
                    <div><input type="number" id="grade-${s.id}" value="${s.grade || ''}" placeholder="Nilai" class="w-16 p-1 border rounded text-sm" max="100"></div>
                    <div><input type="text" id="feedback-${s.id}" value="${s.feedback || ''}" placeholder="Feedback" class="w-32 p-1 border rounded text-sm"></div>
                    <button type="submit" class="bg-pink-500 text-white px-3 py-1 rounded text-sm">Simpan</button>
                </form>
            </div>`;
        }).join('');

        return `<div class="container mx-auto p-6"><button onclick="window.setView('dashboard')" class="mb-4 text-pink-600">‚Üê Kembali</button>${Card(Header(`Pengumpulan: ${task.title}`) + Content(subs.length ? subList : '<p class="text-gray-500">Belum ada yang mengumpulkan.</p>'))}</div>`;
      }
    }

    // ==========================================
    // 6. GLOBAL HANDLERS
    // ==========================================
    window.setView = (view) => { currentView = view; renderApp(); };
    window.viewTask = (id) => { selectedAssignmentId = id; setView('taskDetail'); };
    
    window.handleLogin = (e) => {
      e.preventDefault();
      const res = login(document.getElementById('login-username').value, document.getElementById('login-password').value);
      if (!res.success) {
        document.getElementById('login-error').innerText = res.message;
        document.getElementById('login-error').classList.remove('hidden');
      } else setView('dashboard');
    };

    window.handleCreateTask = async (e) => {
      e.preventDefault();
      const res = await addAssignment(
        document.getElementById('task-title').value, 
        document.getElementById('task-subject').value, 
        document.getElementById('task-deadline').value, 
        document.getElementById('task-desc').value
      );
      if (res.success) { alert('Tugas berhasil dibuat!'); setView('dashboard'); }
      else alert('Gagal: ' + res.message);
    };

    window.handleSubmitTask = async (e) => {
        e.preventDefault();
        if(!window.submissionFileName) return alert("Pilih file dulu");
        const res = await submitAssignment(selectedAssignmentId, window.submissionFileName);
        if(res.success) { alert("Terkirim!"); renderApp(); }
        else alert("Gagal: " + res.message); // MENAMPILKAN PESAN ERROR DARI SUPABASE
    };

    window.handleGrade = async (e, subId) => {
        e.preventDefault();
        const res = await gradeSubmission(
            subId, 
            document.getElementById(`grade-${subId}`).value, 
            document.getElementById(`feedback-${subId}`).value
        );
        if(res.success) alert("Dinilai!");
        else alert("Gagal: " + res.message);
    };

    window.handleDeleteUser = async (id) => {
        if(confirm("Hapus user ini?")) { await adminDeleteUser(id); renderApp(); }
    };
    window.logout = () => { currentUser = null; setView('login'); }

    // ==========================================
    // 7. INITIALIZATION & RENDER
    // ==========================================
    function renderApp() {
      const root = document.getElementById('app-root');
      if (!currentUser) { root.innerHTML = renderLoginPage(); return; }
      
      const navbar = `<nav class="bg-white shadow px-6 py-4 flex justify-between items-center mb-6"><span class="text-xl font-bold text-pink-600">üå∏ GradeUp</span><div class="flex items-center gap-4"><div class="text-right"><div class="font-bold text-gray-800">${currentUser.full_name}</div><div class="text-xs text-gray-500 uppercase">${currentUser.role}</div></div><button onclick="window.logout()" class="text-red-500 text-sm">Logout</button></div></nav>`;

      let content = '';
      if (currentView === 'dashboard') {
         if (currentUser.role === 'student') content = renderStudentDashboard();
         else if (currentUser.role === 'teacher') content = renderTeacherDashboard();
         else if (currentUser.role === 'admin') content = renderAdminDashboard();
      } else if (currentView === 'createTask') content = renderCreateTask();
      else if (currentView === 'taskDetail') content = renderTaskDetail();

      root.innerHTML = navbar + content;
    }

    async function init() {
      document.getElementById('app-root').innerHTML = '<div class="p-10 text-center text-gray-500">Sedang memuat data database...</div>';
      const { data: usersData } = await supabaseClient.from('users').select('*');
      const { data: subData } = await supabaseClient.from('subjects').select('*');
      const { data: assData } = await supabaseClient.from('assignments').select('*');
      const { data: submissionData } = await supabaseClient.from('submissions').select('*');

      if (!usersData) { // Sederhana: jika users null, anggap error koneksi/policy
        document.getElementById('app-root').innerHTML = `<div class="p-10 text-center text-red-600"><h1 class="text-2xl font-bold">Gagal Memuat Database</h1><p class="mt-2">Pastikan RLS Policy sudah diatur!</p></div>`;
        return;
      }

      users = usersData || [];
      subjects = subData ? subData.map(s => s.name) : [];
      assignments = assData || [];
      submissions = submissionData || [];
      
      renderApp();
    }

    init();
  </script>
</body>
</html>
